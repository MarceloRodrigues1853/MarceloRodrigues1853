name: Atualizar README autom√°tico

on:
  schedule:
    - cron: "0 12 * * *" # 09:00 Bras√≠lia (12:00 UTC)
  workflow_dispatch:

concurrency:
  group: profile-readme
  cancel-in-progress: true

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    env:
      GH_USER: MarceloRodrigues1853
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Puxa antes pra evitar "branch atr√°s"
      - name: Sync with remote
        run: |
          git pull --rebase origin main || true

      - name: Gerar README (stats do perfil)
        uses: teoxoy/profile-readme-stats@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          template: ./docs/TEMPLATE.md
          includeForks: false

      - name: Injetar reposit√≥rios recentes
        shell: bash
        run: |
          set -euo pipefail
          echo "üîÑ Buscando reposit√≥rios recentes..."

          curl -s \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/users/$GH_USER/repos?sort=updated&per_page=5&type=all" \
          | jq -r '.[] | "- [\(.name)](\(.html_url)) ‚Äî ‚≠ê \(.stargazers_count) ‚Ä¢ \(.description // "Sem descri√ß√£o") ‚Ä¢ √öltimo commit: \(.updated_at | split("T")[0])"' \
          > repos.tmp

          awk '
            /{{ REPOSITORIES_TEMPLATE_START/ {print; system("cat repos.tmp"); skip=1; next}
            /{{ REPOSITORIES_TEMPLATE_END/ {skip=0}
            skip==0 {print}
          ' README.md > README.tmp && mv README.tmp README.md

          # Limpeza de arquivos tempor√°rios
          rm -f repos.tmp

      - name: Injetar tecnologias por uso
        shell: bash
        run: |
          set -euo pipefail
          echo "üîÑ Calculando tecnologias por uso..."

          # pega todas as urls de linguagens
          curl -s \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/users/$GH_USER/repos?per_page=100" \
          | jq -r '.[].languages_url' > lang_urls.tmp

          if [ ! -s lang_urls.tmp ]; then
            echo "- Nenhuma linguagem detectada" > langs.tmp
          else
            # soma os objetos de linguagens de todos os repos
            LANGS_JSON=$(while read -r url; do
              curl -s -H "Authorization: Bearer $GH_TOKEN" -H "Accept: application/vnd.github+json" "$url" || echo "{}"
            done < lang_urls.tmp | jq -s 'reduce .[] as $item ({}; reduce ($item | to_entries[]) as $lang (.; .[$lang.key] = (.[$lang.key] // 0) + $lang.value))')

            TOTAL=$(echo "$LANGS_JSON" | jq '[to_entries[].value] | add // 0')

            if [ "$TOTAL" -le 0 ]; then
              echo "- Nenhuma linguagem detectada" > langs.tmp
            else
              echo "$LANGS_JSON" | jq -r --argjson total "$TOTAL" '
                to_entries
                | sort_by(-.value)
                | .[:6]
                | .[]
                | "- \(.key) ‚Äî \((.value / $total * 100) | floor)%"
              ' > langs.tmp
            fi
          fi

          awk '
            /{{ LANGUAGE_TEMPLATE_START/ {print; system("cat langs.tmp"); skip=1; next}
            /{{ LANGUAGE_TEMPLATE_END/ {skip=0}
            skip==0 {print}
          ' README.md > README.tmp && mv README.tmp README.md

          # Limpeza de arquivos tempor√°rios
          rm -f lang_urls.tmp langs.tmp

      - name: Limpar arquivos tempor√°rios
        shell: bash
        run: |
          rm -f *.tmp repos.tmp lang_urls.tmp langs.tmp README.tmp
        if: always()

      - name: Commit e Push se houve mudan√ßas
        shell: bash
        run: |
          set -euo pipefail
          if [[ -n "$(git status --porcelain)" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

            git add README.md
            git commit -m "ü§ñ Atualizar README autom√°tico [skip ci]"
            git push origin main
          else
            echo "‚úÖ Nenhuma mudan√ßa detectada."
          fi
