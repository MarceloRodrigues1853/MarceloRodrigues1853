name: Atualizar README autom√°tico

on:
  schedule:
    - cron: "0 12 * * *" # Executa √†s 09:00 Bras√≠lia (12:00 UTC)
  workflow_dispatch: # Permite execu√ß√£o manual

concurrency:
  group: profile-readme
  cancel-in-progress: true

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    env:
      GH_USER: MarceloRodrigues1853
      # O workflow usar√° o GH_TOKEN (Secret que voc√™ est√° criando)
      # Se ele n√£o existir, ele tentar√° usar o GITHUB_TOKEN padr√£o como fallback
      GH_TOKEN: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sincronizar com o remoto
        run: |
          git config pull.rebase true
          git pull origin main || echo "Branch j√° est√° atualizada ou vazia"

      - name: Gerar README (Estat√≠sticas do Perfil)
        id: generate-readme
        continue-on-error: true
        timeout-minutes: 5
        uses: teoxoy/profile-readme-stats@v3
        with:
          token: ${{ env.GH_TOKEN }}
          template: ./docs/TEMPLATE.md
          includeForks: false
          skip_private: false
      
      - name: Fallback - Gerar estat√≠sticas via API REST
        if: steps.generate-readme.outcome == 'failure'
        shell: bash
        run: |
          set -euo pipefail
          echo "‚ö†Ô∏è A Action teoxoy falhou. Iniciando fallback manual..."
          
          # Garante que o README base seja o seu TEMPLATE
          cp docs/TEMPLATE.md README.md
          
          # Coleta dados b√°sicos do usu√°rio
          USER_DATA=$(curl -s -H "Authorization: Bearer $GH_TOKEN" "https://api.github.com/users/$GH_USER")
          REPOS=$(echo "$USER_DATA" | jq -r '.public_repos // 0')
          CREATED_YEAR=$(echo "$USER_DATA" | jq -r '.created_at' | cut -d'-' -f1)
          CURRENT_YEAR=$(date +%Y)
          AGE=$(( CURRENT_YEAR - CREATED_YEAR ))
          
          # Substitui placeholders b√°sicos no README
          sed -i "s/{{ ACCOUNT_AGE }}/$AGE/g" README.md
          sed -i "s/{{ REPOSITORIES }}/$REPOS/g" README.md
          sed -i "s/{{ COMMITS }}/+/g" README.md # Commits totais via REST s√£o complexos, usamos '+'
          
          echo "‚úÖ Estat√≠sticas b√°sicas injetadas via Fallback."

      - name: Injetar Reposit√≥rios Recentes
        shell: bash
        run: |
          set -euo pipefail
          echo "üîÑ Buscando reposit√≥rios recentes..."
          
          curl -s -H "Authorization: Bearer $GH_TOKEN" \
            "https://api.github.com/users/$GH_USER/repos?sort=updated&per_page=5" \
          | jq -r '.[] | "- [\(.name)](\(.html_url)) ‚Äî ‚≠ê \(.stargazers_count) ‚Ä¢ \(.description // "Sem descri√ß√£o")"' \
          > repos.tmp

          # Inje√ß√£o segura usando awk
          awk '/{{ REPOSITORIES_TEMPLATE_START/ {print; system("cat repos.tmp"); skip=1; next} /{{ REPOSITORIES_TEMPLATE_END/ {skip=0} skip==0 {print}' README.md > README.tmp && mv README.tmp README.md

      - name: Injetar Tecnologias (Linguagens)
        shell: bash
        run: |
          set -euo pipefail
          echo "üîÑ Analisando linguagens..."
          
          # Agrupa linguagens dos reposit√≥rios mais recentes
          curl -s -H "Authorization: Bearer $GH_TOKEN" "https://api.github.com/users/$GH_USER/repos?per_page=15&sort=pushed" \
          | jq -r '.[].language' | grep -v "null" | sort | uniq -c | sort -nr \
          | awk '{print "- " $2 " (" $1 " repos)"}' > langs.tmp

          awk '/{{ LANGUAGE_TEMPLATE_START/ {print; system("cat langs.tmp"); skip=1; next} /{{ LANGUAGE_TEMPLATE_END/ {skip=0} skip==0 {print}' README.md > README.tmp && mv README.tmp README.md

      - name: Limpar arquivos tempor√°rios
        run: rm -f *.tmp
        if: always()

      - name: Commit e Push das altera√ß√µes
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          git add README.md
          # S√≥ commita se houver mudan√ßas reais para evitar loops
          if git diff --staged --quiet; then
            echo "Nenhuma altera√ß√£o detectada no README."
          else
            git commit -m "ü§ñ Atualiza√ß√£o autom√°tica do perfil [skip ci]"
            git push origin main
          fi