name: Atualizar README automático

on:
  schedule:
    - cron: '0 12 * * *' # Executa todo dia às 09:00 Brasília (12:00 UTC)
  workflow_dispatch:

concurrency:
  group: profile-readme
  cancel-in-progress: true

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout do repositório
        uses: actions/checkout@v4

      - name: Gerar README (stats do perfil)
        uses: teoxoy/profile-readme-stats@v3
        with:
          token: ${{ secrets.USER_TOKEN }}
          template: ./TEMPLATE.md
          includeForks: false

      - name: Injetar repositórios recentes
        run: |
          REPOS=$(curl -s -H "Authorization: token ${{ secrets.USER_TOKEN }}" \
            "https://api.github.com/users/MarceloRodrigues1853/repos?sort=updated&per_page=5" |
            jq -r '.[] | "- [\(.name)](\(.html_url)) — ⭐ \(.stargazers_count) • \(.description // "Sem descrição") • Último commit: \(.updated_at | split("T")[0])"')
          sed -i "/{{ REPOSITORIES_TEMPLATE_START/,/{{ REPOSITORIES_TEMPLATE_END }}/c\\$REPOS" README.md

      - name: Injetar tecnologias por uso
        run: |
          LANG_URLS=$(curl -s -H "Authorization: token ${{ secrets.USER_TOKEN }}" \
            "https://api.github.com/users/MarceloRodrigues1853/repos?per_page=100" | jq -r '.[].languages_url')
          if [ -z "$LANG_URLS" ]; then
            LANGS="- Nenhuma linguagem detectada"
          else
            LANGS_JSON=$(for url in $LANG_URLS; do
              DATA=$(curl -s -H "Authorization: token ${{ secrets.USER_TOKEN }}" "$url")
              if [ "$DATA" != "{}" ] && [ -n "$DATA" ]; then echo "$DATA"; fi
            done | jq -s 'add')
            TOTAL=$(echo "$LANGS_JSON" | jq '[.[]] | add')
            if [ "$TOTAL" -eq 0 ] 2>/dev/null; then
              LANGS="- Nenhuma linguagem detectada"
            else
              LANGS=$(echo "$LANGS_JSON" | jq --arg total "$TOTAL" -r \
                'to_entries | sort_by(-.value) | .[:6] | map("- \(.key) — \((.value / ($total | tonumber) * 100) | floor)%") | .[]')
            fi
          fi
          sed -i "/{{ LANGUAGE_TEMPLATE_START/,/{{ LANGUAGE_TEMPLATE_END }}/c\\$LANGS" README.md

      - name: Commit e Push se houve mudanças
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add README.md
            git commit -m "Atualizando README automático"
            git push
          else
            echo "Nenhuma alteração detectada."
          fi
